name: Release

# Trigger: push a semver tag like v1.0.0, v1.2.3, v2.0.0-beta.1
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

permissions:
  contents: write   # needed to create the GitHub Release and upload assets

jobs:
  # ─── Analyze & test first (fast gate on Ubuntu) ──────────────────────────
  verify:
    name: Analyze & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: notchprompt_flutter
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.x"
          channel: stable
          cache: true

      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libgtk-3-dev libblkid-dev liblzma-dev \
            libayatana-appindicator3-dev libkeybinder-3.0-dev libnotify-dev

      - name: Install Dart dependencies
        run: flutter pub get

      - name: Code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Analyze
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Test
        run: flutter test

  # ─── macOS: build .app + DMG ─────────────────────────────────────────────
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    needs: verify
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.x"
          channel: stable
          cache: true

      - name: Install Dart dependencies
        run: |
          cd notchprompt_flutter
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build & package DMG
        run: |
          chmod +x scripts/build_release_dmg.sh
          ./scripts/build_release_dmg.sh "${{ github.ref_name }}"
        # For signed + notarized builds uncomment and add secrets:
        # env:
        #   APPLE_ID: ${{ secrets.APPLE_ID }}
        #   APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        #   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        # and pass: --sign "Developer ID Application: ..."

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: notchprompt-macos
          path: dist/notchprompt-*-macos.dmg
          if-no-files-found: error
          retention-days: 1

  # ─── Linux: build bundle + .deb ──────────────────────────────────────────
  build-linux:
    name: Build Linux .deb
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libgtk-3-dev libblkid-dev liblzma-dev \
            libayatana-appindicator3-dev libkeybinder-3.0-dev libnotify-dev \
            dpkg

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.x"
          channel: stable
          cache: true

      - name: Install Dart dependencies
        run: |
          cd notchprompt_flutter
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build & package .deb
        run: |
          chmod +x scripts/build_release_linux.sh
          ./scripts/build_release_linux.sh "${{ github.ref_name }}" --deb

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: notchprompt-linux
          path: dist/notchprompt-*-linux-amd64.deb
          if-no-files-found: error
          retention-days: 1

  # ─── Windows: build bundle + .zip ────────────────────────────────────────
  build-windows:
    name: Build Windows .zip
    runs-on: windows-latest
    needs: verify
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.x"
          channel: stable
          cache: true

      - name: Install Dart dependencies
        shell: bash
        run: |
          cd notchprompt_flutter
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build & package .zip
        shell: bash
        run: |
          chmod +x scripts/build_release_windows.sh
          ./scripts/build_release_windows.sh "${{ github.ref_name }}" --zip

      - name: Upload .zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: notchprompt-windows
          path: dist/notchprompt-*-windows-x64.zip
          if-no-files-found: error
          retention-days: 1

  # ─── Create GitHub Release with all three artifacts ──────────────────────
  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build-macos, build-linux, build-windows]
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: notchprompt-macos
          path: dist/

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: notchprompt-linux
          path: dist/

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: notchprompt-windows
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Notchprompt ${{ github.ref_name }}
          generate_release_notes: true
          files: dist/*
          body: |
            ## Installation

            ### macOS
            1. Download `notchprompt-*-macos.dmg`
            2. Open the DMG and drag **Notchprompt.app** to `/Applications`
            3. First launch: right-click → **Open** (or run `xattr -dr com.apple.quarantine Notchprompt.app` if unsigned)
            4. Notchprompt lives in the **menu bar** — no Dock icon

            ### Linux (Ubuntu 22.04+ / Debian)
            ```bash
            sudo apt install ./notchprompt-*-linux-amd64.deb
            ```
            Requires `libayatana-appindicator3-1` for system tray.
            On GNOME install the **AppIndicator** shell extension if the tray icon is not visible.

            ### Windows
            1. Download `notchprompt-*-windows-x64.zip`
            2. Extract and run `notchprompt.exe`
            3. Notchprompt appears in the **system tray**

            ---
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
